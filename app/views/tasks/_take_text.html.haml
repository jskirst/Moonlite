%div.CRquestionandresponsespace
  -if @completed_task.session_id 
    %div.CRquestionspace
      %span{ style: "font-size: 33px;"}
        Boss Question!
    %pre.CRquestion= @task.question
  -else 
    %div.CRquestionspace
      %span.cr_question_header
        Creative Response:    
    %pre.CRquestion= @task.question
  %div.CRresponsespace{ style: "min-height: 175px;" }
    - if @task.template
      = f.submit "View Preview", class: "button button-small button-info", id: "preview_button", style: "float:right; margin: 0px 10px 3px 0; padding: 3px 10px;"
    = link_to "View hotkeys", "https://github.com/ajaxorg/ace/wiki/Default-Keyboard-Shortcuts", target: '_blank', style: "float: left; position: relative; font-size: 13px; top: 3px; margin-left: 10px;"
    %p{ style:"display: none; float: right; font-size: 12px; margin-right: 15px; top: 15px; position: relative;"} (Save: Ctrl-S, Preview: Ctrl-R)
    %h4{ style: "text-align: center; margin-bottom: 5px; font-size: 15px; border-bottom: 1px solid rgba(0, 0, 0, .1); width: 150px; margin-right: auto; margin-left: auto;" } Your answer:
    %input{ type: "hidden", name: "mode", value: "submit" }
    
    %textarea{ name: "content", id: "answer_input", data: { template: @task.template.to_s } }= @submitted_answer.content || @task.template
    %div{ id: "editor", style:"width: 97%; margin: 0 auto 5px auto; min-height: 275px; position: relative; padding-top:0;"}
        
    - if params[:m] == "preview" and (@task.template or @submitted_answer.preview or @submitted_answer.preview_errors)
      %div{ style: "text-align:center; "}
        %h4{ style: "text-align: center; margin-bottom: 12px; font-size: 17px; border-bottom: 1px solid rgba(0, 0, 0, .1); width: 120px; margin-right: auto; margin-left: auto;" } Preview:
        - if @submitted_answer.preview
          %div{ style: "margin:0 auto; width: 544px; overflow: auto; border: 1px solid #CCC; background-color: white; border-radius: 4px; padding: 4px 6px;" }
            = @submitted_answer.preview
        
        - elsif @submitted_answer.preview_errors
          %div{ style: "margin:0 auto; width: 544px; overflow: auto; border: 1px solid #CCC; background-color: white; border-radius: 4px; padding: 4px 6px; color: red;" }
            = @submitted_answer.preview_errors
          
        - else
          %iframe{ src: raw_path(@submitted_answer.id), style: "margin:0 auto; min-height: 275px; width: 544px; overflow: auto; border: 1px solid #CCC; background-color: white; border-radius: 4px; padding: 4px 6px;" }

    %div{ style: "margin: 10px 0 5px 0; text-align: center;" }
      %a.add_caption{ onclick: "$('#caption').toggle(); $('.add_caption span.caret').toggle();"} 
        %span.text Add caption
      = text_area_tag "caption", @submitted_answer.caption, style: "height: 40px; display: none; margin: 2px 12px;", placeholder: "Caption will appear immediately below your response..."

%div.CRbuttonspace
  - if @session_id.nil?
    = link_to "Back", challenge_path(@section.path.permalink, completed: true), class: "button button-standard", style: "float: left;"
  - else
    = link_to "Skip for now", finish_section_path(@section, @session_id), class: "button button-standard", style: "float: left;"
  - if @submitted_answer.reviewed?
    = f.submit "Update", class: "button button-actionable", id: "submit_button", style: "float:right;"
  - else
    = f.submit "Submit", class: "button button-actionable", id: "submit_button", style: "float:right;"
    = f.submit "Save as Draft", class: "button button-standard", id: "draft_button", style: "float:right; margin-right: 10px;"  
  = image_tag ICON_LOADING_URL, size: "25x25", style: "float: right; display: none; padding: 5px;", id: "loading_image", alt: "Loading"

%script{:charset => "utf-8", :src => "http://d1n0x3qji82z53.cloudfront.net/src-min-noconflict/ace.js", :type => "text/javascript"}
:javascript
  var editor = ace.edit("editor");
  editor.setTheme("ace/theme/github");
  editor.getSession().setMode("ace/mode/#{@path.name.downcase.include?('ruby') ? 'ruby' : 'html'}");
  editor.getSession().setUseSoftTabs(true);
  editor.getSession().setTabSize(2);
  var $textarea = $('textarea[name="content"]').hide();
  var $submit = $("#submit_button");
  editor.getSession().setValue($textarea.val());
  editor.getSession().on('change', function(){
    $textarea.val(editor.getSession().getValue());
    if($textarea.data("template") != $textarea.val()){
      $submit.removeClass("disabled").removeAttr("disabled");
    } else {
      $submit.addClass("disabled").attr("disabled", "disabled");
    }
  });
  
  $("#preview_button").click(function(){
    $("input[name=mode]").val("preview");
  });
  
  $("#draft_button").click(function(){
    $("input[name=mode]").val("draft");
  });

  $("#challenge_form").submit(function(){
    if($("#answer_input").val() != ""){
      $("#challenge_form").unbind("submit");
      $("#challenge_form").submit();
      $("#submit_button").attr("disabled","disabled");
      return true;
    } else {
      alert("Please enter an answer before submitting.");
      $("#submit_button").removeAttr("disabled");
      return false;
    }
  });
  
  $(function(){
    if($textarea.data("template") == $textarea.val()){
      $submit.addClass("disabled").attr("disabled", "disabled");
    }
  });